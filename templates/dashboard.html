<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - {{ username }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { background: #f0f2f5; font-family: Arial, sans-serif; margin: 0; }
        header { background: #4a90e2; color: white; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 30px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 600; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; text-decoration: none; display: inline-block; margin: 4px 2px; font-size: 14px; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .download { background: #27ae60; }
        .delete { background: #e74c3c; }
        .share-btn { background: #3498db; }
        .user-share-btn { background: #9b59b6; font-size: 13px; padding: 8px 12px; }
        .logout { background: #95a5a6; float: right; }
        .dropzone { border: 3px dashed #4a90e2; padding: 50px; text-align: center; border-radius: 10px; margin: 30px 0; background: #f9fbff; transition: 0.3s; font-size: 18px; color: #666; }
        .dropzone.dragover { background: #e3f2fd; border-color: #2980b9; }
        progress { width: 100%; height: 24px; margin: 15px 0; border-radius: 6px; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; margin-bottom: 30px; }
        .stats-card h3 { margin-top: 0; }
        .public-link { font-size: 13px; word-break: break-all; color: #3498db; font-weight: bold; }
        .folder-header { background: #e8f4fd; font-weight: bold; padding: 18px; margin: 40px 0 15px 0; border-left: 6px solid #4a90e2; border-radius: 6px; font-size: 20px; }
        select, input[type=text] { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; }
        .create-folder { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .shared-section { margin-top: 50px; padding: 25px; background: #fffacd; border-radius: 10px; border: 2px dashed #f39c12; }
    </style>
</head>
<body>
    <header>
        <h1>VinnoDrive - {{ username }}'s Dashboard</h1>
        <a href="/logout" class="btn logout">Logout</a>
    </header>

    <div class="container">
        <div class="stats-card">
            <h3>Storage Statistics</h3>
            <p><strong>Actual Storage Used:</strong> {{ (actual_used / 1048576)|round(2) }} / 10 MB</p>
            <progress value="{{ actual_used }}" max="{{ quota_bytes }}" style="width:100%; height:30px;"></progress>
            <p><strong>Original Uploaded Size:</strong> {{ (original_uploaded / 1048576)|round(2) }} MB</p>
            <p><strong>Total Space Saved:</strong> {{ (saved_space / 1048576)|round(2) }} MB ({{ savings_percent|round(1) }}% savings)</p>
        </div>

        <div class="create-folder">
            <h3>Create New Folder</h3>
            <form action="/create_folder" method="post">
                <input type="text" name="folder_name" placeholder="e.g. photos/vacation, documents/work, music/2025" required style="width:500px;">
                <button type="submit" class="btn" style="background:#9b59b6;">Create Folder</button>
            </form>
        </div>

        <div style="margin-bottom: 40px;">
            <div class="dropzone" id="dropzone">üìÅ Drag & Drop Files Here</div>
            <div style="text-align:center; margin:20px 0;">
                <button type="button" id="chooseBtn" class="btn" style="background:#3498db;">üìÇ Choose Files</button>
                <button type="button" id="uploadBtn" class="btn" style="background:#27ae60;">‚¨ÜÔ∏è Upload Files</button>
                <label style="margin-left:20px; font-weight: bold;">Upload to folder:</label>
                <select id="folderSelect" style="margin-left:10px;">
                    <option value="/">Root (/)</option>
                    {% set unique_folders = [] %}
                    {% for file in files %}
                        {% if file.filename.startswith(".folder_marker") and file.folder != "/" %}
                            {% set folder_path = file.folder.rstrip("/") %}
                            {% if folder_path not in unique_folders %}
                                {% set _ = unique_folders.append(folder_path) %}
                                <option value="{{ file.folder }}">{{ folder_path }}</option>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <input type="file" id="fileInput" multiple style="display:none;">
            <progress id="progressBar" value="0" max="100" style="display:none;"></progress>
            <div id="messages" style="margin-top:15px; min-height:40px; font-weight:bold;"></div>
        </div>

        {% set folders = {} %}
        {% for file in files if not file.filename.startswith(".folder_marker") %}
            {% if file.folder not in folders %}
                {% set _ = folders.update({file.folder: []}) %}
            {% endif %}
            {% set _ = folders[file.folder].append(file) %}
        {% endfor %}

        {% if folders|length == 0 %}
            <p style="text-align:center; font-size:18px; color:#777;">No files uploaded yet. Create a folder or upload some files to get started!</p>
        {% else %}
            {% for folder_path, folder_files in folders|dictsort %}
                <div class="folder-header">
                    üìÅ {{ folder_path.rstrip("/") if folder_path != "/" else "Root Folder (/)" }} ({{ folder_files|length }} file{{ "s" if folder_files|length != 1 else "" }})
                </div>
                <table>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Status</th>
                        <th>Upload Date</th>
                        <th>Downloads</th>
                        <th>Public Link</th>
                        <th>Share with User</th>
                        <th>Public Share</th>
                        <th>Actions</th>
                    </tr>
                    {% for file in folder_files %}
                    <tr>
                        <td><strong>{{ file.filename }}</strong></td>
                        <td>{{ (file.size / 1024)|round(2) }} KB</td>
                        <td>
                            {% if file.is_reference == 1 %}
                                <span style="color:#f39c12; font-weight:bold;">Duplicate</span>
                            {% else %}
                                <span style="color:#27ae60; font-weight:bold;">Original</span>
                            {% endif %}
                        </td>
                        <td>{{ file.upload_date.strftime('%b %d, %Y %H:%M') }}</td>
                        <td><strong>{{ file.download_count }}</strong></td>
                        <td>
                            {% if file.is_public == 1 %}
                                <a href="/public/{{ file.share_token }}" target="_blank" class="public-link">
                                    Click to Download ({{ file.download_count }} downloads)
                                </a>
                            {% else %}
                                <span style="color:#999;">Private</span>
                            {% endif %}
                        </td>
                        <td>
                            <form action="/share_with_user" method="post" style="display:inline;">
                                <input type="hidden" name="file_id" value="{{ file.id }}">
                                <input type="text" name="target_username" placeholder="username" required style="width:100px; padding:6px; font-size:13px;">
                                <button type="submit" class="btn user-share-btn">Share</button>
                            </form>
                        </td>
                        <td>
                            <form action="/toggle_share" method="post" style="display:inline;">
                                <input type="hidden" name="file_id" value="{{ file.id }}">
                                <button type="submit" class="btn share-btn">
                                    {% if file.is_public == 1 %}Unshare{% else %}Make Public{% endif %}
                                </button>
                            </form>
                        </td>
                        <td>
                            <a href="/download/{{ file.id }}" class="btn download">Download</a>
                            <form action="/delete" method="post" style="display:inline;">
                                <input type="hidden" name="file_id" value="{{ file.id }}">
                                <button type="submit" class="btn delete" onclick="return confirm('Permanently delete {{ file.filename }}?');">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            {% endfor %}
        {% endif %}

        {% if shared_files|length > 0 %}
            <div class="shared-section">
                <h2 style="margin-top:0;">üì¨ Files Shared with Me ({{ shared_files|length }})</h2>
                <table>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Shared By</th>
                        <th>Upload Date</th>
                        <th>Actions</th>
                    </tr>
                    {% for file in shared_files %}
                    <tr style="background:#fffef0;">
                        <td><strong>{{ file.filename }}</strong> (shared)</td>
                        <td>{{ (file.size / 1024)|round(2) }} KB</td>
                        <td>{{ file.username }}</td>
                        <td>{{ file.upload_date.strftime('%b %d, %Y %H:%M') }}</td>
                        <td>
                            <a href="/download/{{ file.id }}" class="btn download">Download</a>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        {% endif %}
    </div>

    <script>
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");
        const chooseBtn = document.getElementById("chooseBtn");
        const uploadBtn = document.getElementById("uploadBtn");
        const progressBar = document.getElementById("progressBar");
        const messages = document.getElementById("messages");
        const folderSelect = document.getElementById("folderSelect");

        let filesToUpload = [];

        // Choose files button
        chooseBtn.onclick = () => fileInput.click();

        // Drag and drop handlers
        dropzone.addEventListener("dragover", e => { 
            e.preventDefault(); 
            dropzone.classList.add("dragover"); 
        });
        
        dropzone.addEventListener("dragleave", () => {
            dropzone.classList.remove("dragover");
        });
        
        dropzone.addEventListener("drop", e => {
            e.preventDefault();
            dropzone.classList.remove("dragover");
            filesToUpload = Array.from(e.dataTransfer.files);
            updateMessage();
        });

        // File input change handler
        fileInput.addEventListener("change", () => {
            filesToUpload = Array.from(fileInput.files);
            updateMessage();
        });

        function updateMessage() {
            if (filesToUpload.length > 0) {
                const folderName = folderSelect.options[folderSelect.selectedIndex].text;
                messages.innerHTML = `<p style="color:#2c3e50;"><strong>${filesToUpload.length}</strong> file${filesToUpload.length > 1 ? 's' : ''} selected ‚Üí Ready to upload to <strong>${folderName}</strong></p>`;
            } else {
                messages.innerHTML = "";
            }
        }

        // Update message when folder selection changes
        folderSelect.addEventListener("change", updateMessage);

        // Upload handler
        uploadBtn.addEventListener("click", async () => {
            if (filesToUpload.length === 0) {
                alert("Please select at least one file!");
                return;
            }

            const formData = new FormData();
            filesToUpload.forEach(file => formData.append("files", file));
            formData.append("folder", folderSelect.value);

            try {
                progressBar.style.display = "block";
                progressBar.value = 0;
                messages.innerHTML = `<p style="color:#2c3e50;">Uploading ${filesToUpload.length} file${filesToUpload.length > 1 ? 's' : ''}...</p>`;
                uploadBtn.disabled = true;

                const response = await fetch("/upload", {
                    method: "POST",
                    body: formData
                });

                progressBar.value = 100;
                
                if (!response.ok) {
                    const errorData = await response.json();
                    messages.innerHTML = `<p style="color:red; font-weight:bold;">Upload failed: ${errorData.error || 'Server error'}</p>`;
                    return;
                }

                const result = await response.json();
                
                if (result.error) {
                    messages.innerHTML = `<p style="color:red; font-weight:bold;">Error: ${result.error}</p>`;
                    return;
                }

                // Success
                messages.innerHTML = `<p style="color:green; font-weight:bold;">‚úì All files uploaded successfully!</p>`;
                result.results.forEach(r => {
                    messages.innerHTML += `<p style="margin-left:20px;">‚Ä¢ ${r.filename}: <span style="color:green;">${r.message}</span></p>`;
                });

                // Reset form
                filesToUpload = [];
                fileInput.value = "";
                
                // Reload page after 2 seconds
                setTimeout(() => location.reload(), 2000);

            } catch (error) {
                messages.innerHTML = `<p style="color:red; font-weight:bold;">Upload failed: ${error.message}</p>`;
                console.error("Upload error:", error);
            } finally {
                progressBar.style.display = "none";
                uploadBtn.disabled = false;
            }
        });

        // Auto-logout on close (optional - you might want to remove this)
        window.addEventListener("beforeunload", () => {
            navigator.sendBeacon("/logout");
        });
        
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") {
                navigator.sendBeacon("/logout");
            }
        });
    </script>
</body>
</html>
